# 登入系統測試指南

**日期**: 2026-01-05
**新增功能**: Email 登入系統 + 側邊欄改版
**測試狀態**: ⏳ 待測試

---

## 🎯 新增功能說明

### 1. Email 登入系統

**目的**: 在部署環境中隔離不同用戶的資料

**特色**:
- ✅ 只需要 Email，無需密碼
- ✅ Email 格式驗證
- ✅ 自動註冊新用戶或登入現有用戶
- ✅ Email 經過 Hash 加密，保護隱私
- ✅ 顯示用戶 Email 和登出按鈕

### 2. 側邊欄改版

**變更內容**:
- 🏠 首頁改為獨立按鈕（不在功能模組 radio 中）
- 📋 功能模組改為個別按鈕（非 radio）
- 👤 新增用戶資訊顯示和登出按鈕

---

## 🧪 測試步驟

### 第一部分：登入系統測試

#### 測試 1: 初次訪問（新用戶註冊）

1. 啟動應用程式:
   ```bash
   streamlit run app.py --server.port=8503
   ```

2. 訪問 http://localhost:8503

3. **預期結果**:
   - ✅ 顯示登入頁面（看不到主應用程式）
   - ✅ 有 Email 輸入框
   - ✅ 有「登入 / 註冊」按鈕
   - ✅ 顯示功能說明和資料安全說明

4. 輸入一個**新的** Email（例如：`test1@example.com`）

5. 點擊「登入 / 註冊」

6. **預期結果**:
   - ✅ 顯示成功訊息：「🎉 帳號創建成功！歡迎使用 HR 資料處理工具」
   - ✅ 自動進入主應用程式（顯示首頁）
   - ✅ 側邊欄顯示用戶 Email：`👤 test1@example.com`
   - ✅ 側邊欄有「🚪 登出」按鈕

---

#### 測試 2: Email 格式驗證

1. 登出（如果已登入）

2. 嘗試輸入**無效的 Email**:
   - `test` （無 @）
   - `test@` （無域名）
   - `@example.com` （無用戶名）
   - `test @example.com` （有空格）

3. 點擊「登入 / 註冊」

4. **預期結果**:
   - ❌ 顯示錯誤訊息：「❌ Email 格式不正確，請輸入有效的 Email 地址（例如：user@example.com）」
   - ❌ 不允許登入

---

#### 測試 3: 現有用戶登入

1. 登出（如果已登入）

2. 輸入之前註冊過的 Email（例如：`test1@example.com`）

3. 點擊「登入 / 註冊」

4. **預期結果**:
   - ✅ 顯示歡迎訊息：「✅ 歡迎回來！您已成功登入」
   - ✅ 自動進入主應用程式
   - ✅ 側邊欄顯示用戶 Email

---

#### 測試 4: 空白 Email

1. 登出（如果已登入）

2. **不輸入** Email（留空）

3. 點擊「登入 / 註冊」

4. **預期結果**:
   - ⚠️ 顯示警告訊息：「⚠️ 請輸入 Email 地址」

---

#### 測試 5: 登出功能

1. 登入後，點擊側邊欄的「🚪 登出」按鈕

2. **預期結果**:
   - ✅ 顯示成功訊息：「✅ 已成功登出」
   - ✅ 返回登入頁面
   - ✅ 側邊欄不再顯示（因為回到登入頁面）

---

### 第二部分：側邊欄改版測試

#### 測試 6: 登入後的側邊欄佈局

1. 登入任一 Email

2. **檢查側邊欄結構**:

   ```
   HR 資料處理工具
   👤 [your-email]
   [🚪 登出]
   ───────────────
   [🏠 返回首頁] (按鈕)
   ───────────────
   功能模組
   [報表合併器] (按鈕)
   [資料清洗器] (按鈕)
   [員工查詢] (按鈕)
   [資格檢核器] (按鈕)
   [到期提醒] (按鈕)
   ```

3. **預期結果**:
   - ✅ 用戶 Email 顯示在最上方
   - ✅ 登出按鈕在 Email 下方
   - ✅ 首頁按鈕獨立顯示（有分隔線）
   - ✅ 功能模組在另一個區域
   - ✅ 所有按鈕都是完整寬度（use_container_width=True）

---

#### 測試 7: 首頁按鈕樣式

1. 啟動後預設在首頁

2. **檢查首頁按鈕**:
   - ✅ 首頁按鈕應該是 **primary 樣式**（藍色/醒目）
   - ✅ 所有功能模組按鈕應該是 **secondary 樣式**（灰色）

3. 點擊任一功能模組（例如：報表合併器）

4. **檢查按鈕樣式變化**:
   - ✅ 首頁按鈕變成 **secondary 樣式**（灰色）
   - ✅ 被點擊的功能按鈕變成 **primary 樣式**（藍色）

---

#### 測試 8: 返回首頁功能

1. 點擊任一功能模組（例如：資料清洗器）

2. **確認已切換頁面**（應該顯示資料清洗器介面）

3. 點擊「🏠 返回首頁」按鈕

4. **預期結果**:
   - ✅ **單次點擊**即可返回首頁（不需要兩次）
   - ✅ 顯示首頁內容（使用指南）
   - ✅ 首頁按鈕變回 primary 樣式

---

#### 測試 9: 功能模組切換

1. 依序點擊所有功能模組：
   - 報表合併器
   - 資料清洗器
   - 員工查詢
   - 資格檢核器
   - 到期提醒

2. **預期結果**（每次切換都應該）:
   - ✅ 頁面立即切換到對應功能
   - ✅ 對應按鈕變成 primary 樣式
   - ✅ 其他按鈕變成 secondary 樣式
   - ✅ 沒有出現任何錯誤訊息

---

### 第三部分：資料隔離測試（重要！）

#### 測試 10: 多用戶資料隔離

**目的**: 確認不同用戶的資料是否正確隔離

**步驟**:

1. 使用 Email `user1@test.com` 登入

2. 前往「員工查詢」→「資料匯入」
   - 上傳 `test_m4_employee_master.xlsx`
   - 確認成功匯入

3. 登出

4. 使用 Email `user2@test.com` 登入

5. 前往「員工查詢」→「查詢員工」

6. **預期結果**:
   - ❌ **不應該**看到 user1 匯入的資料
   - ⚠️ 應該顯示「資料庫中尚無員工資料」或空白下拉選單

**注意**:
- 🚧 此測試目前**會失敗**，因為我們尚未修改各模組的資料庫查詢邏輯來過濾用戶
- 🚧 這是**下一步**的工作：修改所有模組以支援多用戶資料隔離
- ✅ 但登入系統本身應該正常運作

---

## 📊 測試結果記錄表

### 登入系統測試

| 測試項目 | 預期結果 | 實際結果 | 狀態 |
|---------|---------|---------|------|
| 新用戶註冊 | 創建成功，顯示歡迎訊息 | | [ ] |
| Email 格式驗證 | 拒絕無效 Email | | [ ] |
| 現有用戶登入 | 顯示歡迎回來訊息 | | [ ] |
| 空白 Email | 顯示警告 | | [ ] |
| 登出功能 | 返回登入頁面 | | [ ] |

### 側邊欄測試

| 測試項目 | 預期結果 | 實際結果 | 狀態 |
|---------|---------|---------|------|
| 側邊欄佈局 | 顯示用戶資訊和分隔線 | | [ ] |
| 首頁按鈕樣式 | Primary/Secondary 正確切換 | | [ ] |
| 返回首頁功能 | 單次點擊返回 | | [ ] |
| 功能模組切換 | 所有模組正常切換 | | [ ] |

### 資料隔離測試

| 測試項目 | 預期結果 | 實際結果 | 狀態 |
|---------|---------|---------|------|
| 多用戶資料隔離 | 不同用戶看不到彼此資料 | ⚠️ 尚未實作 | [ ] |

---

## 🔍 檢查用戶資料庫

### 查看已註冊用戶

在測試過程中，您可以查看 `data/users.db` 中的用戶記錄：

```bash
# 使用 SQLite 查看用戶表
sqlite3 data/users.db "SELECT id, email, email_hash, created_at, last_login FROM users;"
```

**預期結果**:
- 每個註冊的 Email 都應該有一筆記錄
- Email 不應重複
- Email_hash 是一個 16 位字元的字串

---

## 🐛 可能遇到的問題

### 問題 1: 登入後仍然停留在登入頁面

**可能原因**: Session state 更新問題

**解決方法**: 檢查 app.py 第 58 行是否有 `st.rerun()`

---

### 問題 2: 登出後沒有返回登入頁面

**可能原因**: Session state 清除不完整

**檢查**: app.py 第 104-107 行的登出邏輯

---

### 問題 3: Email 格式驗證不正確

**檢查**: core/user_manager.py 第 54 行的 regex pattern

---

### 問題 4: 資料庫連線錯誤

**可能原因**: `data/` 資料夾不存在

**解決方法**:
```bash
mkdir data
```

---

## ✅ 測試通過標準

### 第一階段（本次測試）

- [x] 登入系統正常運作
- [x] Email 驗證正確
- [x] 新用戶註冊成功
- [x] 現有用戶登入成功
- [x] 登出功能正常
- [x] 側邊欄佈局正確
- [x] 首頁按鈕正常運作
- [x] 功能模組切換正常
- [ ] 資料隔離（⚠️ 下一步實作）

---

## 📝 下一步工作

完成本次測試後，如果登入系統和側邊欄都正常，接下來需要：

### 1. 修改所有模組以支援多用戶

需要修改的檔案：
- `modules/m1_report_merger.py` - 報表合併器
- `modules/m2_data_cleaner.py` - 資料清洗器
- `modules/m4_employee_dashboard.py` - 員工查詢
- `modules/m5_qualification_check.py` - 資格檢核器
- `modules/m6_reminder_system.py` - 到期提醒

### 2. 修改資料表結構

所有資料表都需要新增 `user_id` 或 `email_hash` 欄位：
- `m4_employees` 表
- `m4_performance` 表
- `m4_training` 表
- `m5_employees` 表
- `m5_separation` 表
- `m5_performance` 表
- `m5_training` 表
- `reminders` 表
- `workflow_templates` 表（M1、M2）

### 3. 更新所有 SQL 查詢

所有 SELECT、INSERT、UPDATE、DELETE 都需要加上 `WHERE user_id = ?` 或 `WHERE email_hash = ?`

---

## 💡 測試提示

### 快速測試指令

```bash
# 啟動應用程式
streamlit run app.py --server.port=8503

# 開啟瀏覽器
# http://localhost:8503

# 清空用戶資料庫（重新測試註冊）
rm data/users.db

# 停止應用程式
# Ctrl + C
```

### 建議測試順序

1. **先測試登入系統**（測試 1-5）
2. **再測試側邊欄**（測試 6-9）
3. **最後測試資料隔離**（測試 10，預期失敗）

---

**開始測試！** 🧪

完成測試後，請告知結果。如果登入系統和側邊欄都正常，我們就可以進行下一步：修改所有模組以支援多用戶資料隔離。
