# 多用戶資料隔離完整測試指南

**日期**: 2026-01-05
**狀態**: ✅ 所有模組已修改完成，資料庫遷移成功

---

## ✅ 已完成的工作

### 1. 模組修改（5個模組）
- ✅ M4 員工查詢 - 使用 `DBManagerMultiUser`
- ✅ M5 資格檢核器 - 使用 `DBManagerMultiUser`
- ✅ M6 到期提醒 - 使用 `DBManagerMultiUser`
- ✅ M1 報表合併器 - 範本支援多用戶
- ✅ M2 資料清洗器 - 範本支援多用戶

### 2. 資料庫遷移
- ✅ 所有資料表已添加 `user_id` 欄位
- ✅ 遷移腳本執行成功
- ✅ 驗證通過

---

## 🧪 測試步驟

### 準備工作

1. **啟動應用程式**:
   ```bash
   streamlit run app.py --server.port=8503
   ```

2. **清除瀏覽器快取**（確保測試乾淨）:
   - 按 `Ctrl + Shift + Delete`
   - 或使用無痕模式

---

### 測試 1: 登入系統基本功能

**目的**: 確認登入系統正常運作

**步驟**:
1. 訪問 http://localhost:8503
2. 應該顯示登入頁面
3. 輸入 Email: `user1@test.com`
4. 點擊「登入 / 註冊」

**預期結果**:
- ✅ 顯示「🎉 帳號創建成功！」
- ✅ 自動進入主應用程式
- ✅ 側邊欄顯示：`👤 user1@test.com`
- ✅ 有「🚪 登出」按鈕

---

### 測試 2: M4 員工查詢 - 多用戶隔離

**目的**: 確認不同用戶的員工資料互不干擾

**步驟 A - User1 匯入資料**:
1. 以 `user1@test.com` 登入
2. 前往「員工查詢」
3. 切換到「資料匯入」分頁
4. 上傳測試檔案：
   - 選擇「員工主檔」
   - 上傳 `tests/test_data/test_m4_employee_master.xlsx`
   - 點擊「執行匯入」
5. 確認匯入成功

**步驟 B - User1 查詢資料**:
1. 切換到「查詢員工」分頁
2. 應該可以看到剛匯入的員工
3. 選擇一位員工查詢
4. 確認可以正常顯示資料

**步驟 C - User2 檢查隔離**:
1. 點擊「登出」
2. 輸入 Email: `user2@test.com`
3. 登入後前往「員工查詢」
4. 切換到「查詢員工」分頁

**預期結果** (關鍵！):
- ❌ User2 應該**看不到** User1 匯入的員工
- ✅ 顯示「資料庫中無員工資料，請先匯入資料」

**步驟 D - User2 匯入自己的資料**:
1. User2 切換到「資料匯入」分頁
2. 上傳同樣的測試檔案
3. 匯入成功後，切換到「查詢員工」
4. 應該可以看到自己匯入的資料

**步驟 E - User1 確認資料仍然獨立**:
1. 登出 User2
2. 以 `user1@test.com` 重新登入
3. 前往「員工查詢」
4. 應該只看到自己的資料（不會看到 User2 的資料）

---

### 測試 3: M5 資格檢核器 - 多用戶隔離

**步驟**:
1. 以 `user1@test.com` 登入
2. 前往「資格檢核器」
3. 切換到「資料匯入」分頁
4. 依序匯入：
   - 員工資料（test_m5_employee_master.xlsx）
   - 離職記錄（test_m5_separation.xlsx）
   - 績效資料（test_m5_performance.xlsx）
   - 訓練記錄（test_m5_training.xlsx）
5. 切換到「資格檢核」分頁
6. 選擇一位員工執行檢核
7. 確認可以正常檢核

8. 登出，以 `user2@test.com` 登入
9. 前往「資格檢核器」
10. 切換到「資格檢核」分頁

**預期結果**:
- ❌ User2 應該**看不到** User1 匯入的員工
- ✅ 顯示「⚠️ 資料庫中尚無員工資料」

---

### 測試 4: M6 到期提醒 - 多用戶隔離

**步驟**:
1. 以 `user1@test.com` 登入
2. 前往「到期提醒」
3. 切換到「新增提醒」分頁
4. 手動新增一筆提醒：
   - 工號：E001
   - 姓名：測試員工1
   - 提醒類型：試用期屆滿
   - 到期日期：選擇明天的日期
   - 備註：User1 的提醒
5. 點擊「新增提醒」
6. 切換到「查看提醒」分頁，確認可以看到

7. 登出，以 `user2@test.com` 登入
8. 前往「到期提醒」
9. 切換到「查看提醒」分頁

**預期結果**:
- ❌ User2 應該**看不到** User1 的提醒
- ✅ 提醒列表為空

---

### 測試 5: M1 範本功能 - 多用戶隔離

**步驟**:
1. 以 `user1@test.com` 登入
2. 前往「報表合併器」
3. 展開「📁 流程範本管理」
4. 切換到「管理範本」分頁
5. 如果有舊範本，記下數量

6. 上傳2個測試檔案進行合併
7. 完成合併後，儲存為範本：
   - 範本名稱：User1 測試範本
   - 說明：這是 User1 的範本
8. 確認範本儲存成功

9. 登出，以 `user2@test.com` 登入
10. 前往「報表合併器」
11. 展開「📁 流程範本管理」
12. 切換到「載入範本」或「管理範本」分頁

**預期結果**:
- ❌ User2 應該**看不到** User1 的範本
- ✅ 範本列表為空（或只有 User2 自己的範本）

---

### 測試 6: M2 範本功能 - 多用戶隔離

**步驟**（類似 M1）:
1. 以 `user1@test.com` 登入
2. 前往「資料清洗器」
3. 上傳檔案並執行清洗
4. 儲存清洗流程為範本：「User1 清洗範本」
5. 登出，以 `user2@test.com` 登入
6. 前往「資料清洗器」
7. 查看範本列表

**預期結果**:
- ❌ User2 看不到 User1 的範本

---

### 測試 7: 登出與重新登入

**步驟**:
1. 以任一用戶登入
2. 在任一模組匯入資料
3. 點擊「登出」
4. 確認返回登入頁面
5. 重新以同一 Email 登入
6. 前往之前的模組

**預期結果**:
- ✅ 重新登入後可以看到自己之前的資料
- ✅ 資料沒有遺失

---

## 📊 測試結果記錄表

| 測試項目 | 預期結果 | 實際結果 | 狀態 |
|---------|---------|---------|------|
| 登入系統 | 正常登入註冊 | | [ ] |
| M4 多用戶隔離 | User2 看不到 User1 資料 | | [ ] |
| M5 多用戶隔離 | User2 看不到 User1 資料 | | [ ] |
| M6 多用戶隔離 | User2 看不到 User1 提醒 | | [ ] |
| M1 範本隔離 | User2 看不到 User1 範本 | | [ ] |
| M2 範本隔離 | User2 看不到 User1 範本 | | [ ] |
| 登出重新登入 | 資料保持 | | [ ] |

---

## ⚠️ 如果測試失敗

### 問題 1: User2 可以看到 User1 的資料

**可能原因**:
- 資料庫遷移未生效
- 模組未正確使用 `user_id` 參數

**解決方法**:
1. 檢查資料庫欄位：
   ```bash
   sqlite3 data/m4_employees.db "PRAGMA table_info(employees);"
   ```
   確認有 `user_id` 欄位

2. 檢查模組程式碼是否正確使用 `DBManagerMultiUser`

---

### 問題 2: 登入後出現錯誤

**可能原因**:
- 模組取不到 `user_info`

**檢查**:
- 確認 `st.session_state.user_info` 存在
- 確認包含 `user_id` 鍵

---

## ✅ 測試通過標準

所有以下項目都必須通過：

- [x] 登入系統正常運作
- [x] M4、M5、M6、M1、M2 都支援多用戶隔離
- [x] 不同用戶之間資料完全獨立
- [x] 登出重新登入資料保持
- [x] 沒有任何錯誤訊息

---

## 🚀 測試通過後的下一步

1. ✅ 確認本地測試全部通過
2. ✅ 同步所有修改到 V2
3. ✅ 推送到 GitHub
4. ✅ 等待 Render 自動部署
5. ✅ 線上環境測試

---

**開始測試！** 🧪

請依照上述步驟逐一測試，並記錄結果。如發現任何問題，請立即回報！
